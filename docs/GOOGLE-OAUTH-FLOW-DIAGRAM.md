# ğŸ“Š Google OAuth Flow Diagram

Visual representation dari OAuth flow untuk Publishify.

---

## ğŸ”„ Complete OAuth Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER (Browser)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (1) Click "Sign in with Google"
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND (Next.js)                               â”‚
â”‚                   http://localhost:3000                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (2) window.location.href = "http://localhost:4000/api/auth/google"
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (NestJS)                                 â”‚
â”‚              GET /api/auth/google                                   â”‚
â”‚                                                                      â”‚
â”‚  Step A: Generate state token                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ const state = crypto.randomBytes(32);       â”‚                   â”‚
â”‚  â”‚ await prisma.oAuthState.create({            â”‚                   â”‚
â”‚  â”‚   state,                                    â”‚                   â”‚
â”‚  â”‚   provider: 'google',                       â”‚                   â”‚
â”‚  â”‚   kadaluarsaPada: now + 5 minutes           â”‚                   â”‚
â”‚  â”‚ });                                         â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Step B: Build Google OAuth URL                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ const googleUrl = "https://accounts..."     â”‚                   â”‚
â”‚  â”‚ + "?client_id=" + CLIENT_ID                 â”‚                   â”‚
â”‚  â”‚ + "&redirect_uri=" + CALLBACK_URL           â”‚                   â”‚
â”‚  â”‚ + "&state=" + state                         â”‚                   â”‚
â”‚  â”‚ + "&scope=profile email"                    â”‚                   â”‚
â”‚  â”‚ + "&response_type=code"                     â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Step C: Redirect                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ return response.redirect(googleUrl);        â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (3) HTTP 302 Redirect
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GOOGLE OAuth Server                              â”‚
â”‚         https://accounts.google.com/o/oauth2/v2/auth               â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  ğŸ” Google Login Page                            â”‚              â”‚
â”‚  â”‚                                                  â”‚              â”‚
â”‚  â”‚  Email: ___________________                      â”‚              â”‚
â”‚  â”‚  Password: _______________                       â”‚              â”‚
â”‚  â”‚                                                  â”‚              â”‚
â”‚  â”‚  [ Sign In ]                                     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (4) User logs in & grants permissions
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GOOGLE OAuth Server                              â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  ğŸ“‹ Consent Screen                               â”‚              â”‚
â”‚  â”‚                                                  â”‚              â”‚
â”‚  â”‚  Publishify wants to:                           â”‚              â”‚
â”‚  â”‚  âœ“ View your email address                      â”‚              â”‚
â”‚  â”‚  âœ“ View your basic profile info                 â”‚              â”‚
â”‚  â”‚                                                  â”‚              â”‚
â”‚  â”‚  [ Cancel ]  [ Allow ]                           â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (5) User clicks "Allow"
             â”‚ Google generates authorization code
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GOOGLE OAuth Server                              â”‚
â”‚                                                                      â”‚
â”‚  Redirect to callback with code & state:                            â”‚
â”‚  http://localhost:4000/api/auth/google/callback?                   â”‚
â”‚    code=4/0AY0e-g7...&                                              â”‚
â”‚    state=abc123...                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (6) HTTP 302 Redirect with code
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (NestJS)                                 â”‚
â”‚          GET /api/auth/google/callback                              â”‚
â”‚          @UseGuards(AuthGuard('google'))                            â”‚
â”‚                                                                      â”‚
â”‚  Step D: GoogleStrategy.validate() triggered                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ // Passport automatically:                  â”‚                   â”‚
â”‚  â”‚ // 1. Exchanges code for access_token       â”‚                   â”‚
â”‚  â”‚ // 2. Fetches user profile from Google      â”‚                   â”‚
â”‚  â”‚ // 3. Calls our validate() method           â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Step E: Validate state (CSRF protection)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ const state = request.query.state;          â”‚                   â”‚
â”‚  â”‚ const oauthState = await prisma             â”‚                   â”‚
â”‚  â”‚   .oAuthState.findUnique({ where: state }); â”‚                   â”‚
â”‚  â”‚                                             â”‚                   â”‚
â”‚  â”‚ if (!oauthState || expired) {               â”‚                   â”‚
â”‚  â”‚   throw UnauthorizedException;              â”‚                   â”‚
â”‚  â”‚ }                                           â”‚                   â”‚
â”‚  â”‚                                             â”‚                   â”‚
â”‚  â”‚ // Delete state (one-time use)              â”‚                   â”‚
â”‚  â”‚ await prisma.oAuthState.delete({ state });  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Step F: Handle Google OAuth                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ const user = await authService               â”‚                   â”‚
â”‚  â”‚   .handleGoogleOAuth({                       â”‚                   â”‚
â”‚  â”‚     googleId: profile.id,                    â”‚                   â”‚
â”‚  â”‚     email: profile.emails[0].value,          â”‚                   â”‚
â”‚  â”‚     namaDepan: profile.name.givenName,       â”‚                   â”‚
â”‚  â”‚     namaBelakang: profile.name.familyName,   â”‚                   â”‚
â”‚  â”‚     avatarUrl: profile.photos[0].value       â”‚                   â”‚
â”‚  â”‚   });                                        â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Step G: Create or find user                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ // Check user exists by email or googleId           â”‚           â”‚
â”‚  â”‚ let pengguna = await prisma.pengguna.findFirst({    â”‚           â”‚
â”‚  â”‚   where: {                                          â”‚           â”‚
â”‚  â”‚     OR: [{ email }, { googleId }]                   â”‚           â”‚
â”‚  â”‚   }                                                 â”‚           â”‚
â”‚  â”‚ });                                                 â”‚           â”‚
â”‚  â”‚                                                     â”‚           â”‚
â”‚  â”‚ if (!pengguna) {                                    â”‚           â”‚
â”‚  â”‚   // NEW USER: Create account                      â”‚           â”‚
â”‚  â”‚   pengguna = await prisma.$transaction(async tx => {â”‚           â”‚
â”‚  â”‚     const newUser = await tx.pengguna.create({     â”‚           â”‚
â”‚  â”‚       email, googleId, provider: 'google',         â”‚           â”‚
â”‚  â”‚       terverifikasi: true, // Auto-verify OAuth    â”‚           â”‚
â”‚  â”‚       avatarUrl                                    â”‚           â”‚
â”‚  â”‚     });                                            â”‚           â”‚
â”‚  â”‚     await tx.profilPengguna.create(...);           â”‚           â”‚
â”‚  â”‚     await tx.peranPengguna.create(...);            â”‚           â”‚
â”‚  â”‚     await tx.profilPenulis.create(...);            â”‚           â”‚
â”‚  â”‚     return newUser;                                â”‚           â”‚
â”‚  â”‚   });                                              â”‚           â”‚
â”‚  â”‚ } else if (!pengguna.googleId) {                   â”‚           â”‚
â”‚  â”‚   // EXISTING USER: Link Google account            â”‚           â”‚
â”‚  â”‚   pengguna = await prisma.pengguna.update({        â”‚           â”‚
â”‚  â”‚     where: { id: pengguna.id },                    â”‚           â”‚
â”‚  â”‚     data: { googleId, avatarUrl }                  â”‚           â”‚
â”‚  â”‚   });                                              â”‚           â”‚
â”‚  â”‚ }                                                  â”‚           â”‚
â”‚  â”‚ // else: User already has googleId â†’ just login    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                      â”‚
â”‚  Step H: Generate JWT tokens                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ const tokens = await authService.login(user);â”‚                   â”‚
â”‚  â”‚ // Returns: { accessToken, refreshToken }    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Step I: Redirect to frontend with tokens                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ const redirectUrl =                          â”‚                   â”‚
â”‚  â”‚   "http://localhost:3000/auth/callback" +    â”‚                   â”‚
â”‚  â”‚   "?token=" + tokens.accessToken +           â”‚                   â”‚
â”‚  â”‚   "&refresh=" + tokens.refreshToken +        â”‚                   â”‚
â”‚  â”‚   "&success=true";                           â”‚                   â”‚
â”‚  â”‚                                             â”‚                   â”‚
â”‚  â”‚ return response.redirect(redirectUrl);       â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (7) HTTP 302 Redirect with JWT tokens
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND (Next.js)                               â”‚
â”‚          /auth/callback?token=...&refresh=...                       â”‚
â”‚                                                                      â”‚
â”‚  Step J: Store tokens                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ const params = new URLSearchParams(          â”‚                   â”‚
â”‚  â”‚   window.location.search                     â”‚                   â”‚
â”‚  â”‚ );                                           â”‚                   â”‚
â”‚  â”‚                                             â”‚                   â”‚
â”‚  â”‚ const token = params.get('token');           â”‚                   â”‚
â”‚  â”‚ const refresh = params.get('refresh');       â”‚                   â”‚
â”‚  â”‚                                             â”‚                   â”‚
â”‚  â”‚ // Store in cookies or localStorage          â”‚                   â”‚
â”‚  â”‚ localStorage.setItem('accessToken', token);  â”‚                   â”‚
â”‚  â”‚ localStorage.setItem('refreshToken', refresh);â”‚                   â”‚
â”‚  â”‚                                             â”‚                   â”‚
â”‚  â”‚ // Or use cookies (more secure)              â”‚                   â”‚
â”‚  â”‚ Cookies.set('accessToken', token, {          â”‚                   â”‚
â”‚  â”‚   secure: true, sameSite: 'strict'           â”‚                   â”‚
â”‚  â”‚ });                                          â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Step K: Redirect to dashboard                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ router.push('/dashboard');                   â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (8) User now logged in
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER (Browser)                               â”‚
â”‚                    âœ… LOGGED IN                                     â”‚
â”‚                                                                      â”‚
â”‚  Dashboard with user info from Google:                              â”‚
â”‚  - Email: user@gmail.com                                            â”‚
â”‚  - Name: John Doe                                                   â”‚
â”‚  - Avatar: Google profile picture                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security Features in Flow

### CSRF Protection (State Parameter)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Backend generates random state                  â”‚
â”‚  state = "abc123xyz..." (64 characters)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Store in database with expiry                   â”‚
â”‚  INSERT INTO oauth_state (state, kadaluarsa_pada)        â”‚
â”‚  VALUES ('abc123...', NOW() + INTERVAL '5 minutes')      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Send to Google as URL parameter                 â”‚
â”‚  redirect: https://accounts.google.com/.../&state=abc123 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Google returns same state in callback           â”‚
â”‚  callback: /api/auth/google/callback?...&state=abc123    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: Backend validates state                         â”‚
â”‚  - Check exists in database âœ“                            â”‚
â”‚  - Check not expired (< 5 min) âœ“                         â”‚
â”‚  - Check matches provider âœ“                              â”‚
â”‚  - Delete after use (one-time) âœ“                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ If state invalid â†’ Throw UnauthorizedException
âœ… If state valid â†’ Continue OAuth flow
```

---

## ğŸ¯ User Scenarios

### Scenario 1: New User (First Time)

```
User â†’ Google Login â†’ Grant Permissions
                              â”‚
                              â–¼
                    Backend checks email
                              â”‚
                              â–¼
                    âŒ Not found in database
                              â”‚
                              â–¼
                    âœ… Create new user:
                       - Pengguna (with googleId)
                       - ProfilPengguna (with avatar)
                       - PeranPengguna (role: penulis)
                       - ProfilPenulis (empty)
                              â”‚
                              â–¼
                    Generate JWT tokens
                              â”‚
                              â–¼
                    Redirect to frontend
                              â”‚
                              â–¼
                    âœ… USER REGISTERED & LOGGED IN
```

### Scenario 2: Existing User (with Password, First OAuth)

```
User â†’ Google Login â†’ Grant Permissions
                              â”‚
                              â–¼
                    Backend checks email
                              â”‚
                              â–¼
                    âœ… Found in database
                    âŒ No googleId
                              â”‚
                              â–¼
                    ğŸ”— Link Google account:
                       - Update googleId
                       - Update avatarUrl
                       - Keep existing password
                              â”‚
                              â–¼
                    Generate JWT tokens
                              â”‚
                              â–¼
                    âœ… USER LOGGED IN (Account Linked)
```

### Scenario 3: Returning OAuth User

```
User â†’ Google Login â†’ Grant Permissions
                              â”‚
                              â–¼
                    Backend checks email
                              â”‚
                              â–¼
                    âœ… Found in database
                    âœ… Has googleId
                              â”‚
                              â–¼
                    Just login:
                       - Update loginTerakhir
                       - Update avatarUrl (if changed)
                              â”‚
                              â–¼
                    Generate JWT tokens
                              â”‚
                              â–¼
                    âœ… USER LOGGED IN
```

---

## ğŸ“Š Database State Changes

### Before OAuth (Empty Database)

```sql
SELECT * FROM pengguna;
-- 0 rows

SELECT * FROM oauth_state;
-- 0 rows
```

### During OAuth Flow (Step A-E)

```sql
SELECT * FROM oauth_state;
-- state: abc123xyz...
-- provider: google
-- kadaluarsa_pada: 2025-01-11 10:05:00
-- dibuat_pada: 2025-01-11 10:00:00
```

### After OAuth Success (Step G)

```sql
SELECT * FROM pengguna WHERE email = 'user@gmail.com';
-- id: uuid-1234
-- email: user@gmail.com
-- google_id: 1234567890
-- provider: google
-- terverifikasi: true
-- avatar_url: https://lh3.googleusercontent.com/...
-- kata_sandi: NULL (OAuth-only user)

SELECT * FROM oauth_state;
-- 0 rows (state deleted after use)

SELECT * FROM log_aktivitas WHERE id_pengguna = 'uuid-1234';
-- aktivitas: "Registrasi via Google"
-- deskripsi: "User mendaftar dengan Google: user@gmail.com"
-- dibuat_pada: 2025-01-11 10:00:00
```

---

## ğŸ”„ Token Refresh Flow (Bonus)

When access token expires:

```
Frontend â†’ Backend: POST /api/auth/refresh
           Body: { refreshToken: "..." }
                        â”‚
                        â–¼
           Backend validates refresh token:
           - Check signature âœ“
           - Check expiry âœ“
           - Check user exists âœ“
                        â”‚
                        â–¼
           Generate new tokens:
           - New accessToken (1 hour)
           - New refreshToken (7 days)
                        â”‚
                        â–¼
           Return tokens to frontend
                        â”‚
                        â–¼
Frontend stores new tokens
         âœ… Continue using app
```

---

## ğŸ“ Notes

- **State expiry**: 5 minutes (configurable via `OAUTH_STATE_EXPIRY`)
- **Access token**: 1 hour (web) or 365 days (mobile)
- **Refresh token**: 7 days (web) or 365 days (mobile)
- **One-time state**: State deleted immediately after validation
- **Transaction safety**: User creation uses Prisma transactions
- **Auto email verification**: OAuth users auto-verified (no email confirmation needed)

---

**Last Updated**: 2025-01-11  
**Version**: 1.0.0
